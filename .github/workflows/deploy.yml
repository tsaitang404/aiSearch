name: è‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare Worker

on:
  push:
    tags:
      - 'v*'  # ä»…åŒ¹é… v* ç‰ˆæœ¬æ ‡ç­¾

jobs:
  deploy:
    name: éƒ¨ç½²åˆ° Cloudflare Worker
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: éªŒè¯é…ç½®
        run: |
          echo "éªŒè¯ wrangler é…ç½®..."
          npx wrangler validate --config config/wrangler.toml
          
      - name: è¿è¡ŒåŸºç¡€æ£€æŸ¥
        run: |
          echo "è¿è¡Œä»£ç æ£€æŸ¥..."
          npm run lint
          
      - name: éƒ¨ç½²åˆ° Cloudflare Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ° Cloudflare Worker..."
          npm run deploy
          
      - name: è·å– Worker URL
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          echo "éƒ¨ç½²å®Œæˆï¼Œè·å– Worker URL..."
          ./.github/scripts/get-worker-url-ci.sh
          
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "æ—¶é—´: $(date -u)"
