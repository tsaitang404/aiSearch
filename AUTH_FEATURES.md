# NeoAI 登录认证功能

## 功能概述

本分支为 NeoAI 添加了完整的用户登录认证系统，包括：

- 用户注册和登录
- 会话管理
- 聊天记录保存
- 用户界面集成

## 新增功能

### 1. 用户认证
- **用户注册**: 支持用户名、邮箱注册
- **用户登录**: 支持用户名或邮箱登录
- **会话管理**: 基于 Cookie 的会话管理
- **密码安全**: SHA-256 哈希 + 盐值加密

### 2. 数据存储
- **D1 数据库**: 使用 Cloudflare D1 数据库存储用户数据
- **聊天记录**: 已登录用户的聊天记录会自动保存
- **会话持久化**: 支持长期登录（7天过期）

### 3. 前端界面
- **登录/注册模态框**: 响应式设计的认证界面
- **用户状态显示**: 头部显示当前登录用户
- **无缝集成**: 与原有聊天功能完全兼容

## 技术实现

### 后端架构

```
src/
├── routes/
│   └── auth.js          # 认证 API 路由
├── utils/
│   ├── auth.js          # 认证工具函数
│   └── database.js      # 数据库操作
└── worker/
    └── index.js         # 主 Worker 入口（已更新）
```

### API 端点

- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/profile` - 获取用户信息
- `GET /api/chat-history` - 获取聊天历史

### 数据库结构

**users 表**
```sql
- id: 用户ID（主键）
- username: 用户名（唯一）
- email: 邮箱（唯一）
- password_hash: 密码哈希
- created_at: 创建时间
- updated_at: 更新时间
- is_active: 是否激活
```

**sessions 表**
```sql
- id: 会话ID（主键）
- user_id: 用户ID（外键）
- created_at: 创建时间
- expires_at: 过期时间
- is_active: 是否激活
```

**chat_history 表**
```sql
- id: 记录ID（主键）
- user_id: 用户ID（外键）
- session_id: 会话ID（外键）
- message: 用户消息
- response: AI响应
- created_at: 创建时间
```

## 部署说明

### 1. 数据库初始化

首先需要初始化 D1 数据库：

```bash
# 运行初始化脚本
./scripts/init-database.sh

# 或直接执行 SQL
wrangler d1 execute neoai --file=scripts/init_db.sql
```

### 2. 配置文件更新

确认 `config/wrangler.toml` 已包含 D1 绑定：

```toml
[[d1_databases]]
binding = "DB"
database_name = "neoai"
database_id = "your-database-id"
```

### 3. 部署

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 部署到生产环境
npm run deploy
```

## 使用说明

### 用户注册
1. 点击右上角"注册"按钮
2. 填写用户名、邮箱、密码
3. 点击"注册"完成账户创建

### 用户登录
1. 点击右上角"登录"按钮
2. 输入用户名/邮箱和密码
3. 登录成功后会显示用户名

### 聊天记录
- 已登录用户的聊天内容会自动保存
- 未登录用户仍可正常使用，但聊天记录不会保存
- 支持通过 API 获取历史聊天记录

## 安全特性

### 密码安全
- 使用 SHA-256 + 盐值哈希存储密码
- 密码要求：至少6位，包含字母和数字

### 会话安全
- HttpOnly Cookie 防止 XSS 攻击
- Secure 标志确保 HTTPS 传输
- SameSite 防止 CSRF 攻击
- 7天会话过期时间

### 输入验证
- 用户名：3-20位字母数字下划线
- 邮箱：标准邮箱格式验证
- 密码：复杂度要求验证

## 兼容性

- ✅ 完全向后兼容原有功能
- ✅ 未登录用户可正常使用聊天
- ✅ 已登录用户获得额外功能
- ✅ 响应式设计支持移动端

## 开发者注意事项

### 环境变量
确保 D1 数据库已正确绑定到 Worker 环境。

### 错误处理
所有认证相关操作都有完善的错误处理和用户反馈。

### 性能优化
- 数据库查询使用索引优化
- 会话验证采用高效的查询策略
- 前端状态管理避免重复请求

### 扩展性
代码架构支持后续功能扩展：
- 用户头像
- 聊天室功能
- 消息分享
- 用户权限管理

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查 D1 数据库是否已创建并绑定
   - 确认 wrangler.toml 配置正确

2. **认证失败**
   - 检查用户输入格式是否正确
   - 查看浏览器控制台错误信息

3. **会话过期**
   - 会话默认7天过期，过期后需重新登录
   - 可通过修改 `auth.js` 中的 `expiresIn` 参数调整

### 调试
- 开发模式下会有详细的错误日志
- 可通过浏览器开发者工具查看网络请求
- 数据库操作日志会显示在 Worker 控制台

## 更新日志

### v2.0.0 (当前版本)
- ✨ 新增用户注册登录功能
- ✨ 新增聊天记录保存
- ✨ 新增会话管理
- ✨ 新增认证相关 API
- 🎨 优化前端用户界面
- 🔒 实现安全的密码存储
- 📱 支持响应式认证界面
